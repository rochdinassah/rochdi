#!/bin/bash

# author: rochdi nassah
# created: 2025/09/21

search=$(adb shell pm list packages|grep $1)

if [ 0 == ${#search} ]
then
  echo package search for \"$1\" error
  exit
fi

package=$(echo $search | sed 's/package\://')

paths=$(adb shell pm path $package)
paths=(${paths// / })

/usr/bin/mkdir ~/Desktop/apk/$1 &> /dev/null
cd ~/Desktop/apk/$1

for path in ${paths[@]}
do
  adb pull $(echo $path | sed 's/package\://')
done

apktool d base.apk -f -o source &&
cd source &&

security_config_content='<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config cleartextTrafficPermitted="true">
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </base-config>
</network-security-config>'
security_config_filename=bmV0cm93a2NvbmZpZw

while read line
do
  if [[ $line =~ "<application" ]]
  then
    if [[ $line =~ android\:networkSecurityConfig=\"@xml\/([a-zA-Z0-9_-]+)\" ]]
    then
      config_filename=${BASH_REMATCH[1]}
      if [ $security_config_filename == $config_filename ]
      then
        echo config security noop!
      else
        echo "$security_config_content" > res/xml/$security_config_filename.xml &&
        sed -i "s/@xml\/$config_filename/@xml\/$security_config_filename/" AndroidManifest.xml &&
        echo config security override \"@xml/$config_filename\" to \"@xml/$security_config_filename\"
      fi
    else
      echo "$security_config_content" > res/xml/$security_config_filename.xml &&
      sed -i "s/<application/<application android:networkSecurityConfig=\"@xml\/$security_config_filename\"/" AndroidManifest.xml &&
      echo config security created \"@xml/$security_config_filename\"
    fi
    break
  fi
done < AndroidManifest.xml