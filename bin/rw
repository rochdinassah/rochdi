#!/usr/bin/env node

// author: rochdi nassah

'use strict';

const rochdi = require('../main');

const { Http2Client, HttpClient, Logger } = rochdi;
const { env } = process;

const logger = new Logger({ prefix: 'restart-wifi', errcb: (err) => process.exit(1)});
const http_client = new HttpClient({ logger: void 0 });
const http2_client = new Http2Client({ logger: void 0 });

env.WIFI_ROUTER_PASS = decrypt('CU/mg/XTvhF78O02wzFfzOYNwg1xVCY+A+CdLTiiQYwAHeQhYki76QO2RNRNGxZn', env.ENCRYPTION_PASSWORD);

const user = env.WIFI_ROUTER_USER || exit('rw: WIFI_ROUTER_USER env is missing');
const pass = env.WIFI_ROUTER_PASS || exit('rw: WIFI_ROUTER_PASS env is missing');

const gateway_url = 'http://192.168.1.2';

function fetchIp(retry_on_error) {
  return http2_client.get('https://ifconfig.me', {
    retry_on_error,
    timeout: retry_on_error ? void 0 : 4e3,
    headers: {
      'user-agent': 'curl'
    }
  }).then(res => {
    http2_client.destroy();
    const { status_code, data } = res;
    if (200 === status_code)
      return data.replace(/[\s\n]/g, '');
  }).catch(noop);
}

function getSessionId() {
  return http_client.get(gateway_url+'/cgi-bin/ajax?ajaxmethod=get_refresh_sessionid').then(res => {
    const { status_code, data } = res;
    if (200 !== status_code)
      exit('getSessionId: request error, http(%d)', status_code);
    return logger.verbose('session_id ok'), data.sessionid;
  });
}

function login(user, pass, session_id) {
  const headers = { 'content-type': 'application/x-www-form-urlencoded' };
  const body = format('username=%s&loginpd=%s&port=0&sessionid=%s&ajaxmethod=do_login', user, pass, session_id);
  return http_client.post(gateway_url+'/cgi-bin/ajax', { headers, body }).then(res => {
    const { status_code, data } = res;
    if (200 !== status_code)
      exit('login: request error, http(%d)', status_code);

    const { session_valid, login_result } = data;

    if (1 !== session_valid)
      exit('login: login error, session_valid: %d', session_valid);

    if (0 !== login_result)
      exit('login: login error, login_result: %d', login_result);

    return logger.verbose('login ok'), session_id;
  });
}

void async function () {
  logger.debug('rebooting');

  const curr_ip = await fetchIp();

  if (curr_ip)
    logger.debug('curr ip: %s', curr_ip);

  return getSessionId().then(session_id => {
    return login(user, pass, session_id).then(async session_id => {
      const options = {
        retry_on_error: false,
        timeout: 2**11,
        headers: {
          'content-type': 'application/x-www-form-urlencoded'
        },
        body: format('sessionid=%s&ajaxmethod=set_onu_reboot', session_id)
      };
      return http_client.post(gateway_url+'/cgi-bin/ajax', options).catch(() => {
        startTimer('Reboot');
        logger.debug('reboot command sent, awaiting for internet...');
        return awaitInternet().then(() => {
          fetchIp(true).then(ip => logger.debug('reboot complete, ip: %s (%s)', ip, endTimer('Reboot')));
        });
      });
    });
  });
}();