#!/usr/bin/env node

// author: rochdi nassah
// created: 2025/09/18

'use strict';

const rochdi = require('../main');

const { Http2Client, HttpClient, Logger } = rochdi;

const http_client = new HttpClient();
const http2_client = new Http2Client();

const user = process.env.WIFI_ROUTER_USER || exit('rw: WIFI_ROUTER_USER env is missing');
const pass = process.env.WIFI_ROUTER_PASS || exit('rw: WIFI_ROUTER_PASS env is missing');

const logger = new Logger({ prefix: 'restart-wifi', errcb: (err) => {
  process.exit(1);
}});

function getToken() {
  const url = 'http://192.168.1.1/asp/GetRandCount.asp';
  return http_client.post(url, { headers: { 'content-length': 0 } }).then(res => {
    const { status_code, data } = res;
    if (200 !== status_code)
      exit('getToken: request error, http(%d)', status_code);
    logger.debug('token ok');
    return data.replace(/\s/, '');
  });
}

function login(user, pass) {
  return getToken().then(token => {
    if (!token)
      return false;
    
    user = encodeURIComponent(user);
    pass = encodeURIComponent(btoa(pass));
    
    const url = 'http://192.168.1.1/login.cgi';
    const body = 'UserName='+user+'&PassWord='+pass+'&Language=english&x.X_HW_Token='+token;
    const headers = {
      'cookie': 'Cookie=body:Language:english:id=-1',
      'accept-encoding': 'gzip, deflate, br',
      'content-type': 'application/x-www-form-urlencoded'
    };

    return http_client.post(url, { headers, body }).then(res => {
      const { status_code, headers, data } = res;
      if (200 !== status_code)
        exit('login: request error, http(%d)', status_code);
      const cookie = headers['set-cookie'];
      if (!cookie || !cookie.length)
        exit('login: did not receive set-cookie header');
      const match = /(CookieHttp\=sid\=[a-z0-9]+\:Language\:english\:id\=1);path\=\/;HttpOnly/.exec(cookie[0]);
      if (!match[1])
        exit('getToken: did not receive CookieHttp');
      logger.debug('login ok');
      return match[1];
    });
  });
}

function getToken2(cookie) {
  return http_client.get('http://192.168.1.1/html/ssmp/accoutcfg/ontmngt.asp', { headers: { cookie } }).then(res => {
    const { status_code, data } = res;
    if (200 !== status_code)
      exit('getToken2: request error, http(%d)', status_code);
    const match = /[a-z0-9]{64}/.exec(data);
    if (!match[0])
      exit('getToken2: token extraction error');
    logger.debug('token2 ok');
    return match[0];
  })
}

function fetchIp() {
  return http2_client.get('https://ifconfig.me', {
    retry_on_error: false,
    timeout: 4e3,
    headers: {
      'user-agent': 'curl'
    }
  }).then(res => {
    const { status_code, data } = res;
    if (200 === status_code)
      return data.replace(/[\s\n]/g, '');
  }).catch(noop);
}

fetchIp().then(ip => logger.debug('curr ip: %s', ip));

logger.debug('rebooting');

login(user, pass).then(cookie => {
  if (!cookie)
    return;
  getToken2(cookie).then(token => {
    if (!token)
      return;
    const url = 'http://192.168.1.1/html/ssmp/accoutcfg/set.cgi?x=InternetGatewayDevice.\
X_HW_DEBUG.SMP.DM.ResetBoard&RequestFile=html/ssmp/accoutcfg/ontmngt.asp';
    const headers = {
      cookie,
      'content-type': 'application/x-www-form-urlencoded'
    };
    http_client.post(url, { headers, body: 'x.X_HW_Token='+token, retry_on_error: false }).catch(noop);
    logger.debug('reboot command sent, awaiting for internet...');
    setTimeout(() => {
      awaitInternet().then(() => {
        fetchIp().then(ip => {
          logger.debug('reboot complete, ip: %s', ip);
        });
      });
    }, 8e3);
  });
});