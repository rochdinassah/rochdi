// author: rochdi nassah
// created: 2025/11/1

'use strict';

const EventEmitter = require('node:events');
const Logger = require('../logger');
const Http2Client = require('../http2-client');
const endpoints = require('./endpoints');

// test account' credentials
const authorization = 'Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IjE5MzQ0ZTY1LWJiYzktNDRkMS1hOWQwLWY5NTdiMDc5YmQwZSIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS92MSJdLCJjbGllbnRfaWQiOiJhcHBfWDh6WTZ2VzJwUTl0UjNkRTduSzFqTDVnSCIsImV4cCI6MTc2Mjg1NjYzMywiaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS9hdXRoIjp7ImNoYXRncHRfY29tcHV0ZV9yZXNpZGVuY3kiOiJub19jb25zdHJhaW50IiwiY2hhdGdwdF9kYXRhX3Jlc2lkZW5jeSI6Im5vX2NvbnN0cmFpbnQiLCJ1c2VyX2lkIjoidXNlci1kcDhuVjZJOGtBSEl3bFRyYzVZMno5N3IiLCJ2ZXJpZmllZF9vcmdfaWRzIjpbIm9yZy1MYUFDWGs2Q0UzQWpva2Y1bFd1YXVydmEiXX0sImh0dHBzOi8vYXBpLm9wZW5haS5jb20vcHJvZmlsZSI6eyJlbWFpbCI6ImdlbmVyYXRvcjQwOTZAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWV9LCJpYXQiOjE3NjE5OTI2MzMsImlzcyI6Imh0dHBzOi8vYXV0aC5vcGVuYWkuY29tIiwianRpIjoiNzhlMjc1YmEtMWM3Ni00OTNlLWI2ZmEtNDg3OWQ0N2ZjNzM2IiwibmJmIjoxNzYxOTkyNjMzLCJwd2RfYXV0aF90aW1lIjoxNzYxOTkyNjMxNzAxLCJzY3AiOlsib3BlbmlkIiwiZW1haWwiLCJwcm9maWxlIiwib2ZmbGluZV9hY2Nlc3MiLCJtb2RlbC5yZXF1ZXN0IiwibW9kZWwucmVhZCIsIm9yZ2FuaXphdGlvbi5yZWFkIiwib3JnYW5pemF0aW9uLndyaXRlIl0sInNlc3Npb25faWQiOiJhdXRoc2Vzc19OTDlCdWdNcUFxaE1NQUhDRUJucVg5bHciLCJzdWIiOiJnb29nbGUtb2F1dGgyfDEwMzM5OTY0NjA0NTA5NzAwMTc2MSJ9.rkilG4ssnBeltCSFNxVAIZ0VI-J1UdCkhB4xNb2sNGmPUR-v10afRJ_QdDQllkA1wPdXwyqWEUKkwwGFM8Fn2FxJGfO7wU7S-Vuq8z1cWa0Xpxa5CDjn3Xo0m3Hl7M6shdp5Zeyrio0JFq901cW2JQzD6HD_LXrhez_R9viuY6zsrpZeWWOd2kZZmjuSU1IHwfbjwXToM6aknIzw3-AqS2tRUwE0TrLjoSYYUiI7R0dQ36iAiQMAHSyNHNl49-k9egN_UKgBv8lNkqx3uAL4cDAIYj8Wp2iG4ql--MFeYpbEWi9MWyxcnOJCSorI-M1Xv1aAnllP_PuCVTQD56SUbq737N_rfnPrkAiQtdctbHLIsJfAXMvyjZnrxOrfG-YABXp2ViokXki3urGvj50nC76ISlAbwO14QbRN8ge2tEhtUqZxnG1ZaKwnglxqG_lo0HYnxsMgQ8hS2UObNhZ_PfnEPeVnNHG9dDwKJUYzzIyHrc1LDfPuYy2Qpw7fgYUalqqAgF49aAkSNrNFGnUOkcnWoNzRL31v6V5PHYGkF14LYy5kgSLgVp_fjpnRm-zxSIK-z0eOxrKOFYHQeRBiFT66Jew9sLGRPB5Qg2HAmTibZ8Ca1XiWmN6fxZHkT5Ck_FY8ML9qB7Jy-W2O4AdVompCgO7PlW-HGeMQCMziJQI';
const device_id = '988c681a-8304-45fb-afbf-9442b8a89827';
const conversation_id = '68c4f2ec-599c-8322-826c-9c5a003200a7';

const client_version = 'prod-9f5aa1f7b48d4577791d0e660bac1111ba132ee6';

const base_url = 'https://chatgpt.com/';

class Openai extends EventEmitter {
  constructor() {
    super();

    this.logger = new Logger({ prefix: 'openai' });
    this.http2_client = new Http2Client({ logger: this.logger });
  }

  fetch_requirements() {
    const { logger } = this;
    const { url, headers, body } = endpoints.requirements;

    return this.post(url, body, headers).then(res => {
      const { statusCode, data } = res;
      
      if (200 !== statusCode)
        return logger.error('fetch_requirements: request error, http(%d)', statusCode), false;

      const { persona, token, expire_after, expire_at, turnstile, proofofwork } = data;
      const { dx } = turnstile;
      const { seed, difficulty } = proofofwork;
    });
  }

  get_requirements() {
    return Promise.resolve('gAAAAABpBe2805t--d4RKM8DYGDBWWj5dtC4GrIbTxJ8epmhjbH-Jtg8V9JWm_ugkk6VejShRA-AQxUWfOdg91jPOdVNjcxh0nhWmhcGjY8zglj0T8wMAVdl_C3eGwGtPzQueQKH1Ta1hrYbqQu3ggPaaI1UZbJ73aQ93T4iNuNmv9sg-qdJuJe5jQePtMQ4c92QpybfE1Ai_jRHrr___GuTyZx18c59sgwr96La1ezIXJkio4Ax3N_et8fu7vMB_SvW9HbD4yWdixp3NSreNDaNq_coIzD8nI6nceQBqBYnTx7dVx36lbWf6zDSIwM8AEj7PR_WZ4_r8ChwgtRqKebf1p22UvoLCRPT_TL01wkJ0fvJygdXv_PRhMhdM67vPMqa9hRyd-1XEyEuWj0ZWHR6LCyeG1kYMFXCz_z4Rt8LSzZ-L7az2gPXYoknlRHmC79KKQgZnPAb61B5eowZsCLLRhx1b1dkqGMYMkv8ZK3-N1wI4SxybShFVbY-beRF0P6tEI0SCMZ_vJUaT9IJrtrpg5EQQDjxSIp6Bue21AxIX2suqgkVpLTZhkbilAsFGh-GtOT0RCQVME1vUUDVeNaCCvP4FgMFlmEFra_Nt7wZDtxPs2PHikh1u7vfNHzLfYdxFfoD_r9mkMFLe-PY5oUU48n0mXumugTK3Vugufp7jT-nTpgBMKTFX3TmNe57LESLwZIgbMVs5Vej48D8S9BzWT9UmVPwiT35hUkGCoyxf0-vDSPJ2zyxKFzKtMmzZ9Q3Je8EKpYngzMf29gCdTK9kIZ_kuIBmD26jsrQYaRnvAqBgIdGrtGJI3bF2j1nTWHO2p1h7yXyVKx99SAbEb4Ld6nXITPonSXCgAkqRGVpCJEjfjom0wWe-eyewxVLtoELtIIEu_LXqGG7QMuD67LW_WXvDb8iK2sw_z7mcmw56nbGuwpEb2F71GiTcA-MrzmhjjR_JJ-fp0Yqpu2CMl-pIki9bUamhrWPOpuWVlQ-0agDHj6C53Abymu3KB4gW6uEn_jTj52WQBsANq17TSGNtIBSyBk7_qmyGnC2SvN6b4AA1emkxYSROaTcTcXfEUN19FFC9SZno2uIYgGQd9D7OQJOOw5K_oQnSciN1kBngBu8tZAOkb4bZyihhqyi_DSa0NmzsSqichSnRhF3JvuUr-5FHrr3DBmQL4IXG1LieR0yhFlRv-oVpCisNDjVCgzs0ont0OwKI3qzJIr-hUMPAqfT65nNyMI33lYpZSYzGWXyMbBqVgamQOdQhghmo_uNofPeJAlRSa35DakV2lU6HregDPzTq-2lRrw2LAM7CsQ9i1woPcEeliziSeA60BbL1A_QG90pMUxwQj5zv1ZQnNHZ7j6Dcx3hNTBvBhanXaHZD6DQlWKPoiZkd7ONjW9SXPu0ZpPeWBqdYTkLadrco62gBKWZ3K5Xqmf2N88wgN1XKuqSxCj2DF8VdaZcI63zq2UuSPfsb3-cNFghIiiDx2tSq6urC-rI3hhbYfHy4-lD6kSNxRd_Hai30u8Mq4qGw3x0ni_FVj0mNcJlU4wjNqxP1lKrVTo_AqsUmckT0i-UfuQAW55M0SbGIh0UJYzaDqPqUr7vRcXjedliF76NJTF8Ywk0Eh_OGW0-Lir4kLYQPP1G7CjL3y9_M2so9J06RlkppB3uR56iC6IgPcKxaAV4M5rY0AcQfWjzS9vvtgOjQ975xyFDcbFkCZ8Vwaa28k8GcDQwTP1hu4y-NuFwIvEtK9sDflSlpS40Syxgm12pLs332V2Kp3SK6e49DKXTkwtwIVsQycHaMvhXVgh39ui8VxUrqMcLuHGMd9Tf0-HkhaLFby7583xD985QRl5-9ruzBRmEueQDXQuLp39M4RGhzsh8QfC2AF_SOPLbhf_bMyX_OE89dBEltnFMsPRicNpBj8fdgrQvsXjmz2EI1P-abkfxRnjupg3Kn6QelWS8jFznFuA=');
  }
  
  send_message(content) {
    return this.get_requirements().then(token => {
      const { url, headers, body } = endpoints.conversation;

      headers['Openai-Sentinel-Chat-Requirements-Token'] = token;
      headers['Openai-Sentinel-Turnstile-Token'] = 'SRQZABkHBAwLFXNeSWh2Y1Vtc18GdGxGfnV+SXR/c1F3VxUeFBgfBwEUFAACAgQcBAcEBRcCAR4UHQEZBAQMCwUCBB4BBQAaDAIFHAMdEw0Qd29wdnN3b3B2c3dvcHZzd29wdnN3b3B2EBoMBAccBRoTDQIYHwcDAAQfAQ4GARcIDwQHHgMbEAUZHwEGFBQTekhVW39ADwsMHRUKDwAEBBAMDGBidHR/ZHFwZ3t3dWNjawgVHhQcAxkDBQwLFXxye0R6VQsTExsQABcfAAQUFBNWYGdPcHVZcm9ZD1R0b2Ruend7cHJwWWNSW2h0eAFPVmBCSWFmTmNTcnpgfmBbaGd5Wg5UYGh8VVRgfHVlXlJPdE9BZ2xjB1R3SV54emdvZ39aZ2pzX1lzbEkPcXJWc0UQGgwEGQAADAsVf0xJRHh2bxMTGxABFh8BAxQUE2RgZH5jBmhUeV9ba2Mea1J2d112dEVnS3llZGJ/dA5rYR1BY2AHdFdlWmd7cHZRcW9WfmZgRWNvYAcfBmEDdE90QAJ1aVZPY2d4f1FjW3hoZlpne3BlQWd4ZHFWYWtzTmEGaHVgWmd7cEB/U2h0bWduQmdSZV5jf3ZFb3lwZUFnf2RTZGcfXmJ0d29+dnNvbXQHVlR6WkNWVR9VcGVaRWd0c2dPZXYPCwwdFQYFAAcOEAxaQ0JXGgwFARwEGxMNRkRbVBsQAhkfBgYUFBNTZFpsZ1tGbmhcU1RgbEZgcFhGa2VeeG12dg8LDB0VCwAAAQQQDAxSBFpGSGl+YX5DVVFjB0pQdlpwGGcHZGZraQJRZ0VFU3oEb1dzXF5oZgdncXdJA2FURUJlUXNsaW9eWktkYmd5aWZ5A1NJBAVrQW9XdlpwGmBbfHdKX0Rhd0lwf3pREwwVHhQdBhkKAwwLFXFREwwVHhQZCBkGAwwLFWpgSnl/XmxtY1sCU3x3U2puaHtRa2BgUGVkA01kYQJSdgAGUGUed2BkYGBJZmdgSmYGB3BPdHFxYB8AZHpbfENuX3wBUgR0Wkt5W0hvaQRcaFhCCVN1XhtSBFFSeXd5VHd4c39jXXtzYGRsbGtiRmN5aU9oVB5jc2VYF3VidHR2ZGJGUEtkU313QgRgZU5CYWZnUmx2YgNseFptW2RCY1ZkTkJTZl58b3YHQnRqAE9VcWZWZ2VuSlxSd3RLaFtKZW9cRHdgb1Z2Y3Ref2J0ZE9kQHRzfHdTd3cfZ39xWkYFdQECZWlgCwNIWmFTU0V/YnAEFlJkRQJoY3Z3cXhwZWRxf2Ryc2RaYXV0Y2l2T11ye1Z+UGJZaHFwTl1VdHNwdnNiC2VsYFhwcUlwbmdgQnBlA3xvY2ILcHZdBmt3H11SY2Nkc2YCAktjYkZnfGdxV3doc3NgXXx5YgJ8aWkHdFB8cw50ZR5nc2UHRntmWkJNZAZocHhaU3FkRghWZAZ4VWJ0dHZ2XHRndlkGam5Fd3J6YBthZlx4TGNifG98dHFmZUNnZGcHWlVRA15UYAZCbHdafXRlHwBVelpCYWBwRnlpB11SeXd5VHd4c39jXXtzb2RsbGBZA2N7XU8GZ3ZzdGBaGwdmAwN6ZlsDTHhdT2tlHn8FYF5BVGJVYHp1TwdgeHBxamJZYHZkcH9mf2ReemlAdGd8AX10d3gIblEGYFBganRKaAYHdXtdAlNvHwRjZwdeQGB3ZEhpBgN1e11uU2d4c1J6YEpUZmdnSmdiC3RNWkd1ZB5/ZGNuSlB/ZF56aUB0Z3wBfXR3e3dkanBkeW8DdEZgBkp+e1pDXm5CY2J6WkJhYHBeemNbB3Vpd3FXYh5nXWVaYHVhcF5mY2JGcmlcYWZwHWN5YQRkRWBlUnRwYGB1fGdHHXFJZ1RwcHwFU0pCfGcHA2x7WQZ2bnhjcXoHZFR0ZFpFcHBRfHZ5eRlsHmtVaF18f3V1Am9ldVFxfGMHcGJ/VWJwZ2dVdlpGenAHRXBpVm53ZVl0VmdBa1J1cFlsdU9aY2x3eWR+b1p2cFFNc290XnlkB3h1aQFxcWIeZ3JlB2twZl58bGNiVlN5ZgZUZUYJcHBnFlJ1RW9tdV8CdGkAcWpieF1kemNgVWF3Y0hkWwZ8eWZmc2xZXVRRBRtfZV5CQ2NyAnNMVnV/cFlrcXpnaH91A2docF8CdWldenZib2RWcFF8fXZgRnpwZUVzaVZyYnFoYHJnB3tSdGN3aXNAdGF2Wl9QZ3xJYWpgQlBmWXhvZwYGUnl3eVR3eHN/Y117c29kbGxgWQdne3dTBGd4c2NWWkpQYXBCfGZcVmN5ZG5QYngEcWNwYHJid3h2ZFB8dXtdcXdlHmRVamBKeX9ebG1jWwJTdgB5dFdCWXJqBxdVZl58eWthQmd8ZG1mbml3cWpgWlRlamB6ZnJwY3xjAmhiH1ZuZwZ0VGZaXk9nBgMHdlpxUGQee3JkB2RZbwNgSmcGSmB2XU9gUHhZY2QHfGFmAXxNYFtKf2kABmpkVgRgY110VX9eZEpmcnBjeHRtaG5mWW1RYEJwZWR8ZWBZRnR8d1NTZ0B/YGpwRn1mAHNqdlsDcHhabXRkH2htY2NkYWIDQnZQYlZgaWB6cHBZfHVzQXdmdlVVS2ZiC29pd3l1bkV4bmRaYHxldHRGZAZCcHZdT2BufABuZwcWc2J3Um1jZnRleXdPc2Uef3JnBmR5b15aHGNyC25/AXJTZ3hzUnpgSlRmZ2dKZlx0YXt3U2FsHwheY2BgUlF0fGxjYgthe19xaGEfCHN6WkJhYHBeemNbB3VpdG1qYUJjcWBaQlBSdFpWZmJwcHtaR3FTHndyZAdeclQDbE1mckZyd2B2U2d4c1J6YEpUZmdnSmBcaHJ7XXlhbEJjYGRaYFJtd1J4Y3ILYHtcfVRnQgBNZQZ4dWB3ZGxnB3h1DB0VBgUABwAQDAx/XWdDYFtmDxQCEwALGB8HFQgUfWNlZXNZAXR1UVZ4cWNRfnl2e1RrdHF6YHt/VnR0f3J1YEFvdmZzZmxgenFzHwhvagZCa2ZKd2N5dnNUa3R9cGd8ZH52TllycEp0a2MGaFB8WWZnd0lkVHN0RXBzRWNqcF98YHZkfVNuQl5mdnRNd3ZKAntgW2BkfFlmZ3d7XgoQGgwJDhwGFhMNEHRZDAoQGgwADhwBGxMNEGFFe1ZjY394cGNwfWkGfHV9ZHF2fmhndWp0RmNwYFFkZ3ZoZ2Z3ZWd+WXxvcXB/V3NaBmpzZQp5ZnBTZ35ZCHlwcHdydVoGanNAeG5pYAoPFAITAwAYHAIVCBRPY2VCbkJZYWVdXWNRXk54cHV/VGt5R3puHnt8dFp3e3ZlBm92X39UbVlYV1RvDAoQGgwCAhwBFxMNEHVJDAoQSw==';

      body.conversation_id = conversation_id;
      body.messages[0].content.parts[0] = content;

      // exit(headers)

      return this.post(url, body, headers);
    });
  }
}

for (const method of ['get', 'post', 'delete', 'put', 'patch']) {
  Openai.prototype[method] = function (endpoint, body, headers) {
    const { http2_client } = this;
    const url = base_url+endpoint.trim('\/');
    headers = {
      ...headers,
      'Authorization': authorization,
      'User-Agent': '',
      'Oai-Device-Id': device_id,
      'Oai-Client-Version': client_version,
      'Origin': base_url.trim('\/')
    };
    if (body)
      headers['Content-Type'] = 'application/json';
    return http2_client[method](url, { headers, body });
  };
}

module.exports = Openai;